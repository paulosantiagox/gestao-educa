<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EJA Chat Widget - VERSÃO OTIMIZADA</title>
</head>
<body>

<!-- ====== POPUP CHAT EJA (Classe .abrirChatEja) ====== -->
<div id="eja-chat-overlay" aria-hidden="true">
  <div class="eja-chat-modal" role="dialog" aria-label="EJA Educa Brasil - Chat">
    <!-- Cabeçalho -->
    <div class="eja-chat-header">
      <div class="eja-brand">
        <div class="eja-logo-wrap">
          <img 
            src="https://ejaeducabrasil.com/wp-content/uploads/2024/06/cropped-EJA-1.png" 
            alt="EJA Educa Brasil" class="eja-logo" loading="lazy" 
          />
        </div>
        <div class="eja-titles">
          <div class="eja-name">EJA Educa Brasil <span class="eja-verified">✅</span></div>
          <div class="eja-status">Online agora</div>
        </div>
      </div>
    </div>

    <!-- Conteúdo -->
    <div class="eja-chat-body" id="ejaChatBody">
      <div class="bubble user">Quero concluir meu Ensino Médio com EJA EAD</div>
      <div class="bubble bot">Que legal, você está quase lá.. parabéns</div>
      <div class="bubble bot">Me confirma seu número de WhatsApp com DDD, por favor 👇</div>

      <!-- Form do número -->
      <form id="ejaPhoneForm" class="eja-phone-row" autocomplete="off">
        <div class="ddi-box">+<input id="ejaDDI" name="ddi" inputmode="numeric" value="55" maxlength="3" aria-label="DDI" /></div>
        <input id="ejaPhone" name="phone" inputmode="numeric" placeholder="WhatsApp com DDD" aria-label="WhatsApp com DDD" />
        <button class="send" type="submit" aria-label="Confirmar número">➜</button>
      </form>

      <!-- Etapa 2 (somente renderiza se usar botões) -->
      <div id="ejaConfirmRow" class="hidden"></div>
    </div>

    <div class="eja-chat-footer">ejaeducabrasil.com</div>
  </div>
</div>

<style>
  :root {
    --eja-green: #1db954;
    --eja-green-strong: #12a345;
    --eja-bg: #f5f7f9;
    --eja-white: #ffffff;
    --eja-text: #202124;
    --eja-muted: #6b7280;
    --eja-bubble: #e9fbe8;
    --eja-shadow: 0 10px 30px rgba(0,0,0,.18);
  }
  #eja-chat-overlay{position:fixed;inset:0;z-index:999999;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.45);padding:16px}
  #eja-chat-overlay.show{display:flex}
  .eja-chat-modal{width:100%;max-width:430px;background:var(--eja-white);border-radius:22px;overflow:hidden;box-shadow:var(--eja-shadow);display:grid;grid-template-rows:auto 1fr auto;max-height:92vh}
  .eja-chat-header{background:linear-gradient(90deg,var(--eja-green),#2dd16f);color:#fff;display:flex;align-items:center;gap:12px;padding:10px 12px}
  .eja-brand{display:flex;align-items:center;gap:10px;min-width:0}
  .eja-logo-wrap{width:42px;height:42px;border-radius:50%;overflow:hidden;background:#fff;border:2px solid rgba(255,255,255,.4);display:grid;place-items:center}
  .eja-logo{width:100%;height:100%;object-fit:contain;background:#fff}
  .eja-titles{display:flex;flex-direction:column;line-height:1.1}
  .eja-name{font-weight:700;display:flex;align-items:center;gap:6px}
  .eja-verified{font-size:14px;padding:0;margin:0}
  .eja-status{font-size:12px;opacity:.95}

  .eja-chat-body{background:var(--eja-bg);padding:14px;overflow-y:auto;display:flex;flex-direction:column;gap:8px}
  .bubble{max-width:85%;padding:10px 12px;border-radius:16px;font-size:14px;line-height:1.35;word-break:break-word;background:#fff;color:var(--eja-text);box-shadow:0 1px 0 rgba(0,0,0,.04)}
  .bubble.bot{background:var(--eja-bubble)}
  .bubble.user{margin-left:auto;background:#e8f0fe}
  .bubble.ok{background:#e6fff2;border:1px solid #b7f2d2}

  /* Layout responsivo do form */
  .eja-phone-row{
    display:flex;
    gap:8px;
    align-items:center;
    margin-top:4px;
    flex-wrap:nowrap;
  }
  .ddi-box{flex:0 0 68px;background:#fff;border-radius:12px;padding:0 8px;display:flex;align-items:center;gap:4px;border:1px solid #e5e7eb;height:44px}
  .ddi-box input{width:40px;border:0;outline:0;font-size:16px;background:transparent;text-align:left}
  #ejaPhone{flex:1;height:44px;border-radius:12px;border:1px solid #e5e7eb;background:#fff;padding:0 12px;font-size:16px;outline:0;min-width:0}
  .send{flex:0 0 48px;height:44px;border-radius:14px;border:0;background:var(--eja-green);color:#fff;font-weight:700;font-size:18px;cursor:pointer;transition:transform .04s ease, background .2s ease}
  .send:hover{background:var(--eja-green-strong)}
  .send:active{transform:translateY(1px)}

  .cta-buttons{display:grid;grid-template-columns:1fr;gap:10px;margin-top:10px}
  .cta{display:inline-flex;align-items:center;justify-content:center;height:54px;padding:0 14px;border-radius:16px;font-weight:800;font-size:15px;text-decoration:none;box-shadow:0 6px 16px rgba(0,0,0,.12)}

  .eja-chat-footer{text-align:center;font-size:12px;color:var(--eja-muted);padding:10px 12px;background:#fff;border-top:1px solid #eef2f7}
  @media (min-width: 992px){.eja-chat-modal{max-width:480px}}
  .hidden{display:none !important}
</style>

<script>
(function () {
  const USE_BUTTONS_MODE = false; // false = sem botões (vai direto pro WhatsApp), true = com botões

  const WEBHOOK_URL = 'https://n8n.centrodaautomacao.net/webhook/eja-webhook';
  const ESCOLA = 'EJA EDUCA BRASIL';
  const FORM_ID = '193152d';
  const FORM_NAME = 'CADASTRO N8N';

  const CONSULTOR_LIST = [
    { codigo: 'vkm', numero: '47991010463' },
    { codigo: 'vtv', numero: '92981617322' }
  ];

  const qs = (s, c=document)=>c.querySelector(s);
  function getParam(n){const u=new URL(location.href);return u.searchParams.get(n)||''}
  function normalizeDigits(s){return (s||'').replace(/\D+/g,'')}
  function dateBR(){
    const d=new Date();
    const dia=String(d.getDate()).padStart(2,'0');
    const mes=String(d.getMonth()+1).padStart(2,'0');
    const ano=d.getFullYear();
    const h=String(d.getHours()).padStart(2,'0');
    const m=String(d.getMinutes()).padStart(2,'0');
    const s=String(d.getSeconds()).padStart(2,'0');
    return `${dia}/${mes}/${ano} ${h}:${m}:${s}`;
  }

  // ===== DISTRIBUIÇÃO OTIMIZADA =====
  function selectConsultor(){
    try {
      // Tenta usar contador persistente no localStorage
      let counter = parseInt(localStorage.getItem('eja_consultor_counter') || '0');
      counter = (counter + 1) % CONSULTOR_LIST.length;
      localStorage.setItem('eja_consultor_counter', counter.toString());
      return CONSULTOR_LIST[counter];
    } catch (e) {
      // Fallback para método original se localStorage não funcionar
      const ts=Date.now();
      const idx=Math.floor((ts/1000)/10)%CONSULTOR_LIST.length;
      return CONSULTOR_LIST[idx];
    }
  }

  // ===== DISTRIBUIÇÃO ALTERNATIVA HÍBRIDA =====
  function selectConsultorHybrid(){
    try {
      // Combina timestamp + contador para maior aleatoriedade
      const ts = Date.now();
      const randomSeed = Math.floor(ts / 1000) + Math.floor(Math.random() * 100);
      let counter = parseInt(localStorage.getItem('eja_consultor_counter') || '0');
      
      // Incrementa contador baseado no seed
      counter = (counter + randomSeed) % CONSULTOR_LIST.length;
      localStorage.setItem('eja_consultor_counter', counter.toString());
      
      return CONSULTOR_LIST[counter];
    } catch (e) {
      // Fallback melhorado com mais aleatoriedade
      const ts = Date.now();
      const randomFactor = Math.floor(Math.random() * 1000);
      const idx = Math.floor((ts + randomFactor) / 1000) % CONSULTOR_LIST.length;
      return CONSULTOR_LIST[idx];
    }
  }

  function buildPayload(whatsComDDD, campos){
    return {
      "WhatsApp com DDD": whatsComDDD,
      "escola": ESCOLA,
      "nome": campos.nome || "",
      "email": campos.email || "",
      "utm": campos.utm || "",
      "utm_source": campos.utm_source || "",
      "utm_campaign": campos.utm_campaign || "",
      "utm_term": campos.utm_term || "",
      "utm_content": campos.utm_content || "",
      "utm_medium": campos.utm_medium || "",
      "lancamento": campos.lancamento || "",
      "data_cadastro": dateBR(),
      "var1": campos.var1 || "",
      "var2": campos.var2 || "",
      "var3": campos.var3 || "",
      "form_id": FORM_ID,
      "form_name": FORM_NAME
    }
  }
  function sendPayloadFireAndForget(payload){
    try{
      if (navigator.sendBeacon) {
        const blob = new Blob([JSON.stringify(payload)], { type: 'application/json' });
        navigator.sendBeacon(WEBHOOK_URL, blob);
        return;
      }
    }catch(_){}
    try{
      fetch(WEBHOOK_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
    }catch(_){}
  }

  function openPopup(){qs('#eja-chat-overlay').classList.add('show');setTimeout(()=>qs('#ejaPhone')?.focus(),50);}
  function closePopup(){qs('#eja-chat-overlay').classList.remove('show');}

  document.addEventListener('click',(e)=>{ if(e.target?.id==='eja-chat-overlay') closePopup(); });
  document.addEventListener('click',function(e){
    const btn=e.target.closest('.abrirChatEja');
    if(btn){e.preventDefault();e.stopPropagation();openPopup();}
  });

  function init(){
    // Usa a distribuição otimizada
    const consultor=selectConsultor();
    let var1=getParam('var1')||consultor.codigo;
    let var2=getParam('var2')||consultor.numero;

    const campos={
      utm:getParam('utm')||'',
      utm_source:getParam('utm_source')||'',
      utm_medium:getParam('utm_medium')||'',
      utm_campaign:getParam('utm_campaign')||'',
      utm_term:getParam('utm_term')||'',
      utm_content:getParam('utm_content')||'',
      var1,var2,
      lancamento:getParam('lancamento')||'',
      nome:getParam('nome')||'',
      email:getParam('email')||''
    };

    const form=qs('#ejaPhoneForm');
    const inputPhone=qs('#ejaPhone');
    const inputDDI=qs('#ejaDDI');

    inputPhone.addEventListener('input',()=>{
      const digits=normalizeDigits(inputPhone.value);
      if(digits.length>=2){
        const ddd=digits.slice(0,2);
        const isCel=digits.length>10;
        const p1=isCel?digits.slice(2,7):digits.slice(2,6);
        const p2=isCel?digits.slice(7,11):digits.slice(6,10);
        inputPhone.value=p2?`(${ddd}) ${p1}-${p2}`:p1?`(${ddd}) ${p1}`:`(${ddd})`;
      }else inputPhone.value=digits;
    });
    inputPhone.addEventListener('keydown',(ev)=>{if(ev.key==='Enter'){ev.preventDefault();form.requestSubmit();}});

    form.addEventListener('submit',(e)=>{
      e.preventDefault();
      const ddi=normalizeDigits(inputDDI.value)||'55';
      const phoneDigits=normalizeDigits(inputPhone.value);
      if(phoneDigits.length<10){inputPhone.focus();return;}
      const whatsComDDD=`(${ddi}) (${phoneDigits.slice(0,2)}) ${phoneDigits.slice(2,7)}-${phoneDigits.slice(7)}`;
      const payload=buildPayload(whatsComDDD,campos);
      const numeroConsultor=normalizeDigits(campos.var2);
      const baseWA=`https://wa.me/55${numeroConsultor}`;

      if(!USE_BUTTONS_MODE){
        sendPayloadFireAndForget(payload);
        window.location.replace(`${baseWA}?text=${encodeURIComponent('Olá! Quero informações sobre minha matrícula do EJA EAD.')}`);
        return;
      }

      // modo com botões (se ativado manualmente)
      fetch(WEBHOOK_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
      const row=qs('#ejaConfirmRow');
      row.innerHTML = `
        <div class="bubble ok">🔒 Número confirmado e seguro!</div>
        <div class="bubble bot">Qual seria sua forma de pagamento?</div>
        <div class="cta-buttons">
          <a href="${baseWA}?text=${encodeURIComponent('Olá! Quero parcelar minha matrícula do EJA EAD (até 12x R$ 89,90).')}" class="cta primary">Parcelado até 12x R$ 89,90</a>
          <a href="${baseWA}?text=${encodeURIComponent('Olá! Quero pagar à vista no Pix (R$ 899).')}" class="cta success">À vista no Pix R$ 899</a>
          <a href="${baseWA}?text=${encodeURIComponent('Olá! Preciso falar com um especialista sobre a matrícula do EJA EAD.')}" class="cta outline">Falar com especialista</a>
        </div>`;
      form.classList.add('hidden');
      row.classList.remove('hidden');
    });
  }

  if(document.readyState==='loading'){document.addEventListener('DOMContentLoaded',init);}else{init();}
})();
</script>

<!-- 
MELHORIAS IMPLEMENTADAS:
✅ Distribuição baseada em contador persistente (localStorage)
✅ Fallback para método original se localStorage falhar
✅ Versão híbrida com mais aleatoriedade disponível
✅ Interface visual mantida 100% igual
✅ Compatibilidade total com código original

INSTRUÇÕES DE USO:
1. Para ativar o chat, adicione a classe "abrirChatEja" em qualquer botão/link
2. Exemplo: <button class="abrirChatEja">Falar no WhatsApp</button>
3. O sistema distribui de forma mais equitativa entre os consultores
4. Para adicionar mais consultores, edite o array CONSULTOR_LIST
-->

</body>
</html>