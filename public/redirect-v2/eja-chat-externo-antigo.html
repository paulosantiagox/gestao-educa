<!-- ====== POPUP CHAT EJA (Classe .abrirChatEja) ====== -->
<div id="eja-chat-overlay" aria-hidden="true">
  <div class="eja-chat-modal" role="dialog" aria-label="EJA Educa Brasil - Chat">
    <!-- CabeÃ§alho -->
    <div class="eja-chat-header">
      <div class="eja-brand">
        <div class="eja-logo-wrap">
          <img
            src="https://ejaeducabrasil.com/wp-content/uploads/2024/06/cropped-EJA-1.png"
            alt="EJA Educa Brasil"
            class="eja-logo"
            loading="lazy"
          />
        </div>
        <div class="eja-titles">
          <div class="eja-name">EJA Educa Brasil <span class="eja-verified">âœ…</span></div>
          <div class="eja-status">Online agora</div>
        </div>
      </div>
    </div>

    <!-- ConteÃºdo -->
    <div class="eja-chat-body" id="ejaChatBody">
      <div class="bubble user">Quero concluir meu Ensino MÃ©dio com EJA EAD</div>
      <div class="bubble bot" id="welcomeMessage">Que legal, vocÃª estÃ¡ quase lÃ¡.. parabÃ©ns</div>
      <div class="bubble bot">Me confirma seu nÃºmero de WhatsApp com DDD, por favor ðŸ‘‡</div>

      <!-- Form do nÃºmero -->
      <form id="ejaPhoneForm" class="eja-phone-row" autocomplete="off">
        <div class="ddi-box">
          +<input id="ejaDDI" name="ddi" inputmode="numeric" value="55" maxlength="3" aria-label="DDI" />
        </div>
        <input
          id="ejaPhone"
          name="phone"
          inputmode="numeric"
          placeholder="WhatsApp com DDD"
          aria-label="WhatsApp com DDD"
        />
        <button class="send" type="submit" aria-label="Confirmar nÃºmero">âžœ</button>
      </form>

      <!-- Etapa 2 -->
      <div id="ejaConfirmRow" class="hidden">
        <div class="bubble ok">ðŸ”’ NÃºmero confirmado e seguro!</div>
        <div class="bubble bot">Qual seria sua forma de pagamento?</div>

        <!-- BotÃµes de aÃ§Ã£o -->
        <div class="cta-buttons">
          <a id="btnParcelado" class="cta primary" target="_blank" rel="noopener">Parcelado atÃ© 12x R$ 89,90</a>
          <a id="btnPix" class="cta success" target="_blank" rel="noopener">Ã€ vista no Pix R$ 899</a>
          <a id="btnEspecialista" class="cta outline" target="_blank" rel="noopener">Falar com especialista</a>
        </div>
      </div>
    </div>

    <div class="eja-chat-footer">ejaeducabrasil.com</div>
  </div>
</div>

<style>
  :root {
    --eja-green: #1db954;
    --eja-green-strong: #12a345;
    --eja-bg: #f5f7f9;
    --eja-white: #ffffff;
    --eja-text: #202124;
    --eja-muted: #6b7280;
    --eja-bubble: #e9fbe8;
    --eja-shadow: 0 10px 30px rgba(0,0,0,.18);
  }
  
  #eja-chat-overlay {
    position: fixed;
    inset: 0;
    z-index: 999999;
    display: none;
    align-items: center;
    justify-content: center;
    background: rgba(0,0,0,.45);
    padding: 16px;
  }
  
  #eja-chat-overlay.show {
    display: flex;
  }
  
  .eja-chat-modal {
    width: 100%;
    max-width: 430px;
    background: var(--eja-white);
    border-radius: 22px;
    overflow: hidden;
    box-shadow: var(--eja-shadow);
    display: grid;
    grid-template-rows: auto 1fr auto;
    max-height: 92vh;
  }
  
  .eja-chat-header {
    background: linear-gradient(90deg, var(--eja-green), #2dd16f);
    color: #fff;
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 10px 12px;
    position: relative;
  }
  
  .eja-chat-header::before {
    content: "";
    position: absolute;
    inset: 0;
    border-top-left-radius: 22px;
    border-top-right-radius: 22px;
    background: linear-gradient(90deg, #1db954, #2dd16f);
    z-index: 0;
  }
  
  .eja-chat-header > * {
    position: relative;
    z-index: 1;
  }
  
  .eja-brand {
    display: flex;
    align-items: center;
    gap: 10px;
    min-width: 0;
    background: transparent !important;
  }
  
  .eja-logo-wrap {
    width: 42px;
    height: 42px;
    border-radius: 50%;
    overflow: hidden;
    background: #fff;
    border: 2px solid rgba(255,255,255,.4);
    display: grid;
    place-items: center;
  }
  
  .eja-logo {
    width: 100%;
    height: 100%;
    object-fit: contain;
    background: #fff;
  }
  
  .eja-titles {
    display: flex;
    flex-direction: column;
    line-height: 1.1;
  }
  
  .eja-name {
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: 6px;
  }
  
  .eja-verified {
    font-size: 14px;
    padding: 0;
    margin: 0;
  }
  
  .eja-status {
    font-size: 12px;
    opacity: .95;
  }

  .eja-chat-body {
    background: var(--eja-bg);
    padding: 14px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
  
  .bubble {
    max-width: 85%;
    padding: 10px 12px;
    border-radius: 16px;
    font-size: 14px;
    line-height: 1.35;
    word-break: break-word;
    background: #fff;
    color: var(--eja-text);
    box-shadow: 0 1px 0 rgba(0,0,0,.04);
  }
  
  .bubble.bot {
    background: var(--eja-bubble);
  }
  
  .bubble.user {
    margin-left: auto;
    background: #e8f0fe;
  }
  
  .bubble.ok {
    background: #e6fff2;
    border: 1px solid #b7f2d2;
  }

  .eja-phone-row {
    display: grid;
    grid-template-columns: 72px 1fr 48px;
    gap: 8px;
    align-items: center;
    margin-top: 4px;
  }
  
  .ddi-box {
    background: #fff;
    border-radius: 12px;
    padding: 0 8px;
    display: flex;
    align-items: center;
    gap: 4px;
    border: 1px solid #e5e7eb;
    height: 44px;
  }
  
  .ddi-box input {
    width: 40px;
    border: 0;
    outline: 0;
    font-size: 16px;
    background: transparent;
    text-align: left;
  }
  
  #ejaPhone {
    height: 44px;
    border-radius: 12px;
    border: 1px solid #e5e7eb;
    background: #fff;
    padding: 0 12px;
    font-size: 16px;
    outline: 0;
  }
  
  .send {
    height: 44px;
    border-radius: 14px;
    border: 0;
    background: var(--eja-green);
    color: #fff;
    font-weight: 700;
    font-size: 18px;
    cursor: pointer;
    transition: transform .04s ease, background .2s ease;
  }
  
  .send:hover {
    background: var(--eja-green-strong);
  }
  
  .send:active {
    transform: translateY(1px);
  }

  .cta-buttons {
    display: grid;
    grid-template-columns: 1fr;
    gap: 10px;
    margin-top: 10px;
  }
  
  .cta {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    height: 54px;
    padding: 0 14px;
    border-radius: 16px;
    font-weight: 800;
    font-size: 15px;
    text-decoration: none;
    box-shadow: 0 6px 16px rgba(0,0,0,.12);
  }
  
  .cta.primary {
    background: #2563eb;
    color: #fff;
  }
  
  .cta.success {
    background: var(--eja-green);
    color: #fff;
  }
  
  .cta.outline {
    background: #fff;
    color: #2563eb;
    border: 2px solid #2563eb;
  }
  
  .cta:hover {
    filter: brightness(1.04);
  }

  .eja-chat-footer {
    text-align: center;
    font-size: 12px;
    color: var(--eja-muted);
    padding: 10px 12px;
    background: #fff;
    border-top: 1px solid #eef2f7;
  }
  
  @media (min-width: 992px) {
    .eja-chat-modal {
      max-width: 480px;
    }
  }
  
  .hidden {
    display: none;
  }
</style>

<script>
(function () {
  // ========== CONFIGURAÃ‡Ã•ES ==========
  const USE_BUTTONS_MODE = false;
  const REDIRECT_DELAY_SECONDS = 0.2;
  const WEBHOOK_URL = 'https://n8n.centrodaautomacao.net/webhook/eja-webhook';
  const API_BASE_URL = 'https://gestao-educa.autoflixtreinamentos.com/api/public';
  const ESCOLA = 'EJA EDUCA BRASIL';
  const FORM_ID = '193152d';
  const FORM_NAME = 'CADASTRO N8N';
  
  const CONSULTOR_LIST_FALLBACK = [
    { codigo: 'vkm', numero: '47991010463' },
    { codigo: 'vtv', numero: '92981617322' }
  ];

  // ========== FUNÃ‡Ã•ES UTILITÃRIAS ==========
  const qs = (s, c = document) => c.querySelector(s);
  
  function getParam(n) {
    const u = new URL(location.href);
    return u.searchParams.get(n) || '';
  }
  
  function normalizeDigits(s) {
    return (s || '').replace(/\D+/g, '');
  }
  
  function dateBR() {
    const d = new Date();
    const dia = String(d.getDate()).padStart(2, '0');
    const mes = String(d.getMonth() + 1).padStart(2, '0');
    const ano = d.getFullYear();
    const h = String(d.getHours()).padStart(2, '0');
    const m = String(d.getMinutes()).padStart(2, '0');
    const s = String(d.getSeconds()).padStart(2, '0');
    return `${dia}/${mes}/${ano} ${h}:${m}:${s}`;
  }
  
  function selectConsultorFallback() {
    const ts = Date.now();
    const idx = Math.floor((ts / 1000) / 10) % CONSULTOR_LIST_FALLBACK.length;
    return CONSULTOR_LIST_FALLBACK[idx];
  }
  
  function addVarParamsToUrl(v1, v2) {
    const url = new URL(location.href);
    if (v1) url.searchParams.set('var1', v1);
    if (v2) url.searchParams.set('var2', v2);
    history.replaceState({}, '', url.toString());
  }

  // ========== DETECÃ‡ÃƒO DE PLATAFORMA ==========
  function detectPlatform() {
    const utmSource = getParam('utm_source').toLowerCase().trim();
    console.log('ðŸ” [DETECT PLATFORM] utm_source:', utmSource || '(vazio)');
    
    if (!utmSource) {
      console.log('âœ… [DETECT PLATFORM] Sem utm_source â†’ Plataforma: GOOGLE (padrÃ£o)');
      return 'google';
    }
    
    if (utmSource.includes('google')) {
      console.log('âœ… [DETECT PLATFORM] ContÃ©m "google" â†’ Plataforma: GOOGLE');
      return 'google';
    }
    
    const metaVariants = ['insta', 'bio', 'bio-insta', 'fb', 'ig', 'facebook', 'instagram', 'meta', 'metaads', 'meta-ads'];
    if (metaVariants.some(variant => utmSource.includes(variant))) {
      console.log('âœ… [DETECT PLATFORM] ContÃ©m variante Meta â†’ Plataforma: META');
      return 'meta';
    }
    
    console.log('âœ… [DETECT PLATFORM] Outro valor â†’ Plataforma: GOOGLE (fallback)');
    return 'google';
  }

  // ========== API DE REDIRECIONAMENTO ==========
  async function getNextRedirect(platform) {
    console.log('ðŸ“¡ [API REQUEST] Buscando consultor para plataforma:', platform);
    
    try {
      const response = await fetch(`${API_BASE_URL}/next-redirect?platform=${platform}`, {
        method: 'GET',
        headers: { 'Accept': 'application/json' }
      });
      
      console.log('ðŸ“¡ [API RESPONSE] Status:', response.status);
      
      if (!response.ok) {
        if (response.status === 404) {
          console.warn('âš ï¸ [API RESPONSE] 404 - Nenhum consultor ativo');
          return null;
        }
        throw new Error(`API retornou ${response.status}`);
      }
      
      const result = await response.json();
      console.log('âœ… [API RESPONSE] Dados recebidos:', result);
      
      const data = result.data || result;
      const consultorData = {
        numero: normalizeDigits(data.numero),
        codigo: data.consultor?.utm_consultor || data.consultor?.name || 'api',
        consultorNome: data.consultor?.name || 'N/A',
        consultorEmail: data.consultor?.email || 'N/A',
        consultorUtm: data.consultor?.utm_consultor || 'N/A',
        token: data.token,
        platform: data.plataforma,
        expiresInMinutes: data.expires_in_minutes
      };
      
      console.log('âœ… [API RESPONSE] Consultor:', consultorData.consultorNome, '(', consultorData.numero, ')');
      return consultorData;
      
    } catch (error) {
      console.error('âŒ [API ERROR]', error);
      return null;
    }
  }

  async function confirmRedirect(numero, platform, token, leadData) {
    console.log('ðŸ“¡ [CONFIRM REQUEST] Confirmando...');
    
    try {
      const response = await fetch(`${API_BASE_URL}/confirm-redirect`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          numero: numero,
          platform: platform,
          token: token,
          lead_data: leadData
        })
      });
      
      console.log('ðŸ“¡ [CONFIRM RESPONSE] Status:', response.status);
      
      if (response.ok) {
        console.log('âœ… [CONFIRM] Sucesso');
        return true;
      }
      return false;
      
    } catch (error) {
      console.error('âŒ [CONFIRM ERROR]', error);
      return false;
    }
  }

  // ========== WEBHOOK N8N ==========
  function buildPayload(whatsComDDD, campos) {
    return {
      "WhatsApp com DDD": whatsComDDD,
      "escola": ESCOLA,
      "nome": campos.nome || "",
      "email": campos.email || "",
      "utm": campos.utm || "",
      "utm_source": campos.utm_source || "",
      "utm_campaign": campos.utm_campaign || "",
      "utm_term": campos.utm_term || "",
      "utm_content": campos.utm_content || "",
      "utm_medium": campos.utm_medium || "",
      "lancamento": campos.lancamento || "",
      "data_cadastro": dateBR(),
      "var1": campos.var1 || "",
      "var2": campos.var2 || "",
      "var3": campos.var3 || "",
      "form_id": FORM_ID,
      "form_name": FORM_NAME
    };
  }

  function sendToWebhook(payload) {
    console.log('ðŸ“¤ [WEBHOOK] Enviando para N8N...');
    console.log('ðŸ“¤ [WEBHOOK] URL:', WEBHOOK_URL);
    console.log('ðŸ“¤ [WEBHOOK] Payload:', payload);
    
    fetch(WEBHOOK_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload),
      keepalive: true
    })
    .then(r => {
      console.log('âœ… [WEBHOOK] Status:', r.status);
      return r.text();
    })
    .then(d => console.log('âœ… [WEBHOOK] Response:', d))
    .catch(e => console.error('âŒ [WEBHOOK] Erro:', e));
  }

  // ========== CONTROLE DO POPUP ==========
  function openPopup() {
    qs('#eja-chat-overlay').classList.add('show');
    setTimeout(() => qs('#ejaPhone')?.focus(), 50);
  }
  
  function closePopup() {
    qs('#eja-chat-overlay').classList.remove('show');
  }

  document.addEventListener('click', e => {
    if (e.target?.id === 'eja-chat-overlay') closePopup();
  });

  document.addEventListener('click', function (e) {
    const btn = e.target.closest('.abrirChatEja');
    if (btn) {
      e.preventDefault();
      e.stopPropagation();
      openPopup();
    }
  });

  // ========== INICIALIZAÃ‡ÃƒO ==========
  async function init() {
    console.log('ðŸš€ [INIT] Iniciando...');
    
    const platform = detectPlatform();
    let consultorData = await getNextRedirect(platform);
    
    if (!consultorData) {
      console.log('âš ï¸ [FALLBACK] Usando fallback');
      const fallback = selectConsultorFallback();
      consultorData = {
        numero: fallback.numero,
        codigo: fallback.codigo,
        consultorNome: 'Fallback',
        consultorUtm: fallback.codigo,
        token: null,
        platform: platform,
        isFallback: true
      };
    }
    
    let var1 = consultorData.consultorUtm || consultorData.codigo;
    let var2 = consultorData.numero;
    addVarParamsToUrl(var1, var2);
    console.log('ðŸ“ [INIT] var1:', var1, 'var2:', var2);
    
    const campos = {
      utm: getParam('utm') || '',
      utm_source: getParam('utm_source') || '',
      utm_medium: getParam('utm_medium') || '',
      utm_campaign: getParam('utm_campaign') || '',
      utm_term: getParam('utm_term') || '',
      utm_content: getParam('utm_content') || '',
      var1: var1,
      var2: var2,
      var3: getParam('var3') || '',
      lancamento: getParam('lancamento') || '',
      nome: getParam('nome') || '',
      email: getParam('email') || ''
    };
    
    const welcomeMsg = qs('#welcomeMessage');
    if (welcomeMsg && consultorData.consultorNome && consultorData.consultorNome !== 'N/A' && consultorData.consultorNome !== 'Fallback') {
      welcomeMsg.textContent = `Que legal, me chamo ${consultorData.consultorNome}, vocÃª estÃ¡ quase lÃ¡.. parabÃ©ns`;
      console.log('âœ… [INIT] Nome:', consultorData.consultorNome);
    }
    
    const form = qs('#ejaPhoneForm');
    const inputPhone = qs('#ejaPhone');
    const inputDDI = qs('#ejaDDI');
    
    inputPhone.addEventListener('input', () => {
      const digits = normalizeDigits(inputPhone.value);
      if (digits.length >= 2) {
        const ddd = digits.slice(0, 2);
        const isCel = digits.length > 10;
        const p1 = isCel ? digits.slice(2, 7) : digits.slice(2, 6);
        const p2 = isCel ? digits.slice(7, 11) : digits.slice(6, 10);
        inputPhone.value = p2 ? `(${ddd}) ${p1}-${p2}` : p1 ? `(${ddd}) ${p1}` : `(${ddd})`;
      } else {
        inputPhone.value = digits;
      }
    });
    
    inputPhone.addEventListener('keydown', ev => {
      if (ev.key === 'Enter') {
        ev.preventDefault();
        form.requestSubmit();
      }
    });
    
    form.addEventListener('submit', async e => {
      e.preventDefault();
      console.log('ðŸ“¤ [FORM SUBMIT] Enviado');
      
      const ddi = normalizeDigits(inputDDI.value) || '55';
      const phoneDigits = normalizeDigits(inputPhone.value);
      
      if (phoneDigits.length === 0) {
        inputPhone.focus();
        inputPhone.setAttribute('placeholder', 'Digite seu WhatsApp');
        return;
      }
      
      console.log('ðŸ“¤ [FORM] Tel:', phoneDigits);
      
      const whatsComDDD = `(${ddi}) (${phoneDigits.slice(0, 2)}) ${phoneDigits.slice(2, 7)}-${phoneDigits.slice(7)}`;
      
      const leadData = {
        source: 'site',
        utm_source: campos.utm_source,
        utm_medium: campos.utm_medium,
        utm_campaign: campos.utm_campaign,
        utm_term: campos.utm_term,
        utm_content: campos.utm_content,
        page_url: window.location.href,
        referrer: document.referrer || '',
        nome: campos.nome,
        email: campos.email,
        whatsapp_lead: whatsComDDD,
        lancamento: campos.lancamento,
        var3: campos.var3
      };
      
      const payload = buildPayload(whatsComDDD, campos);
      const numeroConsultor = normalizeDigits(campos.var2);
      const baseWA = `https://wa.me/55${numeroConsultor}`;
      
      console.log('ðŸ“± [WA] NÃºmero:', numeroConsultor);
      
      form.classList.add('hidden');
      
      if (consultorData.token) {
        console.log('âœ… [CONFIRM] Confirmando...');
        await confirmRedirect(consultorData.numero, consultorData.platform, consultorData.token, leadData);
      }
      
      console.log('ðŸ“¤ [WEBHOOK] Enviando AGORA...');
      sendToWebhook(payload);
      
      console.log(`â±ï¸ [WAIT] ${REDIRECT_DELAY_SECONDS}s...`);
      setTimeout(() => {
        console.log('ðŸš€ [REDIRECT] Agora!');
        
        if (!USE_BUTTONS_MODE) {
          const redirectUrl = `${baseWA}?text=${encodeURIComponent('OlÃ¡! Quero saber mais sobre a conclusÃ£o do Ensino MÃ©dio pelo EJA EAD.')}`;
          window.location.replace(redirectUrl);
          return;
        }
        
        qs('#ejaConfirmRow').classList.remove('hidden');
        qs('#btnParcelado').href = `${baseWA}?text=${encodeURIComponent('OlÃ¡! Quero parcelar minha matrÃ­cula do EJA EAD (atÃ© 12x R$ 89,90).')}`;
        qs('#btnPix').href = `${baseWA}?text=${encodeURIComponent('OlÃ¡! Quero pagar Ã  vista no Pix (R$ 899).')}`;
        qs('#btnEspecialista').href = `${baseWA}?text=${encodeURIComponent('OlÃ¡! Preciso falar com um especialista sobre a matrÃ­cula do EJA EAD.')}`;
      }, REDIRECT_DELAY_SECONDS * 1000);
    });
    
    console.log('âœ… [INIT] Pronto!');
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
})();
</script>